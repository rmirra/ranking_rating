<!doctype html>
<html>
<head>
    <title>Image Quality Evaluation</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css">
    <style>
        body { max-width: 2800px; margin: 0 auto; }
        .image-container {
            text-align: center;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin: 10px;
            background-color: #f9f9f9;
        }
        .image-container img {
            max-width: 200px;
            height: auto;
            border-radius: 4px;
            padding: 5px;
        }
        .eval-row {
            margin-bottom: 40px;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }
        .eval-row > .d-flex {
            flex-wrap: wrap !important;
            justify-content: center;
        }
        .score-buttons {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .target-label {
            margin-top: 6px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        hr.row-divider {
            border-top: 2px dashed #ccc;
            margin: 30px 0;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="jumbotron mt-3">
    <h1>Image Quality Evaluation</h1>
    <hr class="my-4">
    <p>Thank you for volunteering in our experiments!</p>
    <p>Below is a target image and several neural models (including ours) are trying to get as close as possible to the target.</p>
    <p>Click “<b>1</b>” for the closest image and “<b>2</b>” for the second closest.</p>
    <p>Please select exactly two methods (unique rank) per sample.</p>
    <h2>Differences will be subtle!</h2>
</div>

    <!-- Email -->
    <div class="form-group">
        <label><strong>Email (required)</strong></label>
        <input type="email" class="form-control" id="user-email" required>
    </div>

    <!-- PAGE 1 -->
    <form id="form-page1">
        <h3>Page 1 (Required)</h3>
        <div id="container-page1"></div>
        <div class="text-center">
            <button class="btn btn-primary" type="submit">Submit Page 1</button>
        </div>
    </form>

    <hr style="margin:60px 0;">

    <!-- PAGE 2 -->
    <div id="page2-wrapper" style="display:none;">
        <h3>Page 2 (Optional)</h3>
        <p>If you are motivated, you may continue with Page 2.</p>

        <form id="form-page2">
            <div id="container-page2"></div>
            <div class="text-center">
                <button class="btn btn-secondary" type="submit">Submit Page 2</button>
            </div>
        </form>
    </div>
</div>

<script>
let CONFIG = null;
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxVJAw4KzBXx5fVTjAPSLpy3S4sbMWfz2WPakNEaUVjhIEM_WvzTtleUfiK6DGBOUFq_A/exec";

/* ---------- utils ---------- */
function shuffleArray(a){
    return a.map(v=>({v, r:Math.random()}))
            .sort((x,y)=>x.r-y.r)
            .map(o=>o.v);
}

/* ---------- render ---------- */
function renderPage(items, containerId, pageTag){
    const container = document.getElementById(containerId);
    container.innerHTML = "";

    items.forEach((item, idx)=>{
        const row = document.createElement("div");
        row.className = "eval-row";

        const imgRow = document.createElement("div");
        imgRow.className = "d-flex";

        // target
        const t = document.createElement("div");
        t.className = "image-container";
        t.innerHTML = `
            <img src="data/images/${item.part}/id_${item.id}/target.png">
            <div class="target-label">Target</div>`;
        imgRow.appendChild(t);

        // methods
        shuffleArray(Object.values(item.anon_map)).forEach(method=>{
            const d = document.createElement("div");
            d.className = "image-container";

            const img = document.createElement("img");
            img.src = `data/images/${item.part}/id_${item.id}/${method}.png`;
            d.appendChild(img);

            const radios = document.createElement("div");
            radios.className = "score-buttons";

            [1,2].forEach(rank=>{
                const label = document.createElement("label");
                const r = document.createElement("input");
                r.type = "radio";
                r.name = `rank_${pageTag}_${idx}_${method}`;
                r.value = rank;

                // toggleable radio
                r.addEventListener("click", function(){
                    if(this.wasChecked){
                        this.checked = false;
                        this.wasChecked = false;
                    } else {
                        this.wasChecked = true;
                    }
                });

                label.appendChild(r);
                label.append(` ${rank}`);
                radios.appendChild(label);
            });

            d.appendChild(radios);
            imgRow.appendChild(d);
        });

        row.appendChild(imgRow);
        container.appendChild(row);
        container.appendChild(document.createElement("hr")).className="row-divider";
    });
}

/* ---------- submit ---------- */
function submitPage(items, pageTag, formId){
    const email = document.getElementById("user-email").value.trim();
    if(!email){
        alert("Please enter your email.");
        return;
    }

    const rows = [];
    let errorRow = null;

    items.forEach((item, idx)=>{
        let found = [];
        Object.values(item.anon_map).forEach(method=>{
            const radios = document.getElementsByName(`rank_${pageTag}_${idx}_${method}`);
            let rank = 999;
            radios.forEach(r=>{ if(r.checked) rank = parseInt(r.value); });
            if(rank===1||rank===2) found.push(rank);
            rows.push({ part:item.part, id:item.id, method, rank, page:pageTag });
        });

        if(found.length!==2 || !found.includes(1) || !found.includes(2)){
            errorRow = document.getElementsByClassName("eval-row")[idx];
        }
    });

    if(errorRow){
        errorRow.scrollIntoView({behavior:"smooth", block:"center"});
        alert("Please rank top-2 for all samples.");
        return;
    }

    fetch(GOOGLE_SCRIPT_URL,{
        method:"POST",
        mode:"no-cors",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({ user_name: email, rows })
    }).then(()=>{
        if (pageTag === "p1") {
    alert(
        "Page 1 completed successfully.\n\n" +
        "Now, if you are motivated, please feel free to scroll down for Page 2."
    );
} else {
    alert("Page 2 completed successfully. Thank you!");
}
        if(pageTag==="p1") document.getElementById("page2-wrapper").style.display="block";
        document.getElementById(formId).reset();
    });
}

/* ---------- wiring ---------- */
document.getElementById("form-page1").onsubmit = e=>{
    e.preventDefault();
    submitPage(CONFIG.items.filter((_,i)=>i%2===0),"p1","form-page1");
};
document.getElementById("form-page2").onsubmit = e=>{
    e.preventDefault();
    submitPage(CONFIG.items.filter((_,i)=>i%2===1),"p2","form-page2");
};

fetch("./data/config.json")
    .then(r=>r.json())
    .then(cfg=>{
        CONFIG = cfg;
        renderPage(CONFIG.items.filter((_,i)=>i%2===0),"container-page1","p1");
        renderPage(CONFIG.items.filter((_,i)=>i%2===1),"container-page2","p2");
    });
</script>
</body>
</html>
