<!doctype html>
<html>
<head>
    <title>Image Quality Evaluation</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css">

    <style>
        body { max-width: 2800px; margin: 0 auto; }
        .image-container {
            text-align: center;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin: 10px;
            background-color: #f9f9f9;
        }
        .image-container img {
            max-width: 200px;
            height: auto;
            border-radius: 4px;
            padding: 5px;
        }
        .eval-row {
            margin-bottom: 40px;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
        }
        .eval-row > .d-flex {
            flex-wrap: wrap !important;
            justify-content: center;
        }
        .score-buttons {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }
        .target-label {
            margin-top: 6px;
            font-size: 0.95rem;
            font-weight: 600;
        }
        hr.row-divider {
            border-top: 2px dashed #ccc;
            margin: 30px 0;
        }
    </style>
</head>

<body>
<div class="container">

<div class="jumbotron mt-3">
    <h1>Image Quality Evaluation</h1>
    <hr>
    <p>
        Click <b>1</b> for the closest image and <b>2</b> for the second closest.
        You must pick exactly two images per sample.
    </p>
</div>

<!-- EMAIL -->
<div class="form-group">
    <label><strong>Email address</strong></label>
    <input type="email" class="form-control" id="user-email" required>
</div>

<hr>

<!-- PAGE 1 -->
<h2>Page 1 (Required)</h2>
<form id="form-page1">
    <div id="container-page1"></div>
    <div class="text-center">
        <button class="btn btn-primary" type="submit">Submit Page 1</button>
    </div>
</form>

<hr style="margin:60px 0;">

<!-- PAGE 2 -->
<div id="page2-block" style="display:none;">
    <h2>Page 2 (Optional)</h2>
    <p>If you are motivated, you may continue with Page 2.</p>

    <form id="form-page2">
        <div id="container-page2"></div>
        <div class="text-center">
            <button class="btn btn-secondary" type="submit">Submit Page 2</button>
        </div>
    </form>
</div>

</div>

<script>
const GOOGLE_SCRIPT_URL =
"https://script.google.com/macros/s/AKfycbxVJAw4KzBXx5fVTjAPSLpy3S4sbMWfz2WPakNEaUVjhIEM_WvzTtleUfiK6DGBOUFq_A/exec";

let CONFIG = null;

function shuffle(arr) {
    return arr.map(x => ({x, r: Math.random()}))
              .sort((a,b)=>a.r-b.r)
              .map(o=>o.x);
}

function makeRow(item, idx, pageTag) {
    const row = document.createElement("div");
    row.className = "eval-row";

    const wrap = document.createElement("div");
    wrap.className = "d-flex";

    // target
    const t = document.createElement("div");
    t.className = "image-container";
    t.innerHTML = `<img src="data/images/${item.part}/id_${item.id}/target.png">
                   <div class="target-label">Target</div>`;
    wrap.appendChild(t);

    const methods = shuffle(Object.values(item.anon_map));

    methods.forEach(method=>{
        const d = document.createElement("div");
        d.className = "image-container";
        d.innerHTML = `<img src="data/images/${item.part}/id_${item.id}/${method}.png">`;

        const radios = document.createElement("div");
        radios.className = "score-buttons";

        [1,2].forEach(rank=>{
            const label = document.createElement("label");
            const r = document.createElement("input");
            r.type="radio";
            r.name=`rank_${pageTag}_${idx}_${method}`;
            r.value=rank;
