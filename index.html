<!doctype html>
<html>
<head>
    <title>Image Quality Evaluation</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css">
    <style>
        body { max-width: 2800px; margin: 0 auto; }
        .image-container {
            text-align: center;
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 8px;
            margin: 10px;
            background-color: #f9f9f9;
        }
        .image-container img { max-width: 200px; height: auto; border-radius: 4px; padding: 5px; }
        .eval-row { margin-bottom: 40px; padding: 10px; border: 2px solid #dee2e6; border-radius: 8px; }
        .eval-row > .d-flex { flex-wrap: wrap !important; justify-content: center; }
        .score-buttons { margin-top: 10px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        #submit-btn { margin-top: 30px; }
        .target-label { margin-top: 6px; font-size: 0.95rem; font-weight: 600; color: #333; }
        hr.row-divider { border-top: 2px dashed #ccc; margin: 30px 0; }
    </style>
</head>
<body>
<div class="container">
    <div class="jumbotron mt-3">
        <h1>Image Quality Evaluation</h1>
        <hr class="my-4">
        <p>Thank you for volunteering in our experiments!</p>
        <p>Below is a target image and several neural models (including ours) are trying to get as close as possible to the target.</p>
        <p>Click “<b>1</b>” for the closest image and “<b>2</b>” for the second closest.</p>
        <p>Please select exactly two methods (unique rank) per sample;.</p>
        <h2>Differences will be subtle!</h2>
        <hr>
    </div>

    <form id="rating-form">
        <div id="evaluation-container"></div>
        <div class="d-flex justify-content-center">
            <button type="submit" class="btn btn-primary" id="submit-btn">Submit Ratings</button>
        </div>
    </form>
</div>

<script>
let CONFIG = null;

// shuffle function
function shuffleArray(array) {
    return array.map(v=>({v,sort:Math.random()})).sort((a,b)=>a.sort-b.sort).map(o=>o.v);
}

// render function: show methods with only radio 1 and 2
function render() {
    const container = document.getElementById("evaluation-container");
    container.innerHTML = "";

    CONFIG.items.forEach((item, idx) => {
        const row = document.createElement("div");
        row.className = "eval-row";

        const imgRow = document.createElement("div");
        imgRow.className = "d-flex justify-content-start flex-wrap";

        // Target image first
        const targetDiv = document.createElement("div");
        targetDiv.className = "image-container";
        const targetImg = document.createElement("img");
        targetImg.src = `data/images/${item.part}/id_${item.id}/target.png`;
        targetDiv.appendChild(targetImg);
        const targetLabel = document.createElement("div");
        targetLabel.className = "target-label";
        targetLabel.textContent = "Target";
        targetDiv.appendChild(targetLabel);
        imgRow.appendChild(targetDiv);

        // Methods shuffled
        const methods = shuffleArray(Object.values(item.anon_map));

        methods.forEach((method) => {
            const div = document.createElement("div");
            div.className = "image-container";

            const img = document.createElement("img");
            img.src = `data/images/${item.part}/id_${item.id}/${method}.png`;
            div.appendChild(img);

            // Rank 1 / 2 radios
            const radioDiv = document.createElement("div");
            radioDiv.className = "score-buttons";

            [1,2].forEach(rank => {
                const radioLabel = document.createElement("label");
                radioLabel.className = "form-check-label";
                radioLabel.style.marginRight = "5px";

                const radio = document.createElement("input");
                radio.type = "radio";
                radio.name = `rank_${idx}_${method}`;
                radio.value = rank;

                // --- Make radio toggleable ---
                radio.addEventListener("click", function() {
                    if (this.wasChecked) {
                        this.checked = false;
                        this.wasChecked = false;
                    } else {
                        this.wasChecked = this.checked;
                    }
                });
    // -----------------------------

    radioLabel.appendChild(radio);
    radioLabel.appendChild(document.createTextNode(` ${rank}`));
    radioDiv.appendChild(radioLabel);
});


            div.appendChild(radioDiv);
            imgRow.appendChild(div);
        });

        row.appendChild(imgRow);
        container.appendChild(row);
        container.appendChild(document.createElement("hr")).className="row-divider";
    });
}

// submit handler
const GOOGLE_SCRIPT_URL = "YOUR_GOOGLE_SCRIPT_URL_HERE";

document.getElementById("rating-form").addEventListener("submit", function(e){
    e.preventDefault();

    const results = [];
    let firstErrorRow = null;
    let errorFlag = false;

    CONFIG.items.forEach((item, idx) => {
        const methods = Object.values(item.anon_map);
        let selectedRanks = [];

        methods.forEach(method => {
            const radios = document.getElementsByName(`rank_${idx}_${method}`);
            let rank = 999; // default unselected
            radios.forEach(r => { if(r.checked) rank = parseInt(r.value); });
            if(rank === 1 || rank === 2) selectedRanks.push(rank);
            results.push({ part:item.part, id:item.id, method:method, rank:rank });
        });

        // check for exactly one rank 1 and one rank 2
        if(selectedRanks.length !== 2 || !selectedRanks.includes(1) || !selectedRanks.includes(2)) {
            errorFlag = true;
            firstErrorRow = document.getElementsByClassName("eval-row")[idx];
            return;
        }
    });

    if(errorFlag) {
        if(firstErrorRow) firstErrorRow.scrollIntoView({behavior:"smooth", block:"center"});
        alert("Please rank top-2 for all samples.");
        return;
    }

    const payload = {
        user_name: "", // optional
        rows: results
    };

    const submitBtn = document.getElementById("submit-btn");
    submitBtn.disabled = true;
    submitBtn.textContent = 'Submitting...';

    fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(() => {
        alert("Thank you! Your evaluation has been submitted successfully.");
        submitBtn.textContent = 'Submit';
        submitBtn.disabled = false;
        document.getElementById("rating-form").reset();
    }).catch(err => {
        alert("Submission error. Please try again.");
        console.error(err);
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
    });
});


// load config
fetch("./data/config.json")
    .then(r=>r.json())
    .then(cfg=>{ CONFIG=cfg; render(); })
    .catch(err=>console.error("Failed to load config.json:",err));
</script>
</body>
</html>
